From 7209eda144fb00366894fe4efad8965f43026b14 Mon Sep 17 00:00:00 2001
From: Shashank Ram <shashr2204@gmail.com>
Date: Wed, 26 May 2021 11:08:11 -0700
Subject: [PATCH] pipelines: add AKS addon nightly job

Signed-off-by: Shashank Ram <shashr2204@gmail.com>
---
 .pipelines/e2e-aks-addon-jobs.yaml            | 12 +++++++++++
 .pipelines/e2e-aks-addon.yaml                 | 21 +++++++++++++++++++
 .../templates/enable-osm-aks-addon.yaml       |  4 ++++
 .pipelines/templates/run-upstream-e2e.yaml    |  8 +++----
 4 files changed, 41 insertions(+), 4 deletions(-)
 create mode 100644 .pipelines/e2e-aks-addon-jobs.yaml
 create mode 100644 .pipelines/e2e-aks-addon.yaml
 create mode 100644 .pipelines/templates/enable-osm-aks-addon.yaml

diff --git a/.pipelines/e2e-aks-addon-jobs.yaml b/.pipelines/e2e-aks-addon-jobs.yaml
new file mode 100644
index 0000000..f733d57
--- /dev/null
+++ b/.pipelines/e2e-aks-addon-jobs.yaml
@@ -0,0 +1,12 @@
+jobs:
+  - job: test_osm_aks_addon
+    pool: Upstream Pool
+    workspace:
+      clean: all
+    steps:
+    - template: templates/checkout-upstream-repo.yaml
+    - template: templates/aks-setup.yaml
+    - template: templates/enable-osm-aks-addon.yaml
+    - template: templates/run-upstream-e2e.yaml
+    - template: templates/debug-resources.yaml
+    - template: templates/aks-cleanup.yaml
diff --git a/.pipelines/e2e-aks-addon.yaml b/.pipelines/e2e-aks-addon.yaml
new file mode 100644
index 0000000..7c58d99
--- /dev/null
+++ b/.pipelines/e2e-aks-addon.yaml
@@ -0,0 +1,21 @@
+trigger: none
+
+schedules:
+  - cron: "0 0 * * *"
+    always: true
+    displayName: "OSM AKS Addon Nightly Test"
+    branches:
+      include:
+        - main
+
+pool: Upstream Pool
+
+variables:
+  KUBECONFIG: $(System.DefaultWorkingDirectory)/kubeconfig.json
+  upstream.repo: https://github.com/openservicemesh/osm
+  CHART_VERSION: 0.8.4
+
+stages:
+- stage: run_e2e
+  jobs:
+    - template: e2e-aks-addon-jobs.yaml
diff --git a/.pipelines/templates/enable-osm-aks-addon.yaml b/.pipelines/templates/enable-osm-aks-addon.yaml
new file mode 100644
index 0000000..5bb061d
--- /dev/null
+++ b/.pipelines/templates/enable-osm-aks-addon.yaml
@@ -0,0 +1,4 @@
+steps:
+  - bash: |
+      az aks enable-addons --addons open-service-mesh -g ${AZURE_CLUSTER_NAME} -n ${AZURE_CLUSTER_NAME}
+    displayName: Enable OSM AKS addon
\ No newline at end of file
diff --git a/.pipelines/templates/run-upstream-e2e.yaml b/.pipelines/templates/run-upstream-e2e.yaml
index 664ced0..03922f0 100644
--- a/.pipelines/templates/run-upstream-e2e.yaml
+++ b/.pipelines/templates/run-upstream-e2e.yaml
@@ -1,12 +1,12 @@
-steps: 
+steps:
   - bash: |
       sleep 180
     displayName: "Add delay before running upstream e2es"
   - bash: |
-      make build-osm 
-      go test ./tests/e2e -test.v -ginkgo.v -ginkgo.progress -test.timeout 60m -installType=NoInstall -OsmNamespace=arc-osm-system
+      make build-osm
+      go test ./tests/e2e -test.v -ginkgo.v -ginkgo.progress -test.timeout 60m -installType=NoInstall -OsmNamespace=$(release.namespace)
     displayName: "Run upstream e2e tests"
-    env: 
+    env:
       CTR_REGISTRY: $(UPSTREAM_DOCKER_REGISTRY)
       CTR_TAG: v$(CHART_VERSION)
     workingDirectory: $(System.DefaultWorkingDirectory)/osm
-- 
2.25.1

