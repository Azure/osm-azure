{{- if .Values.OpenServiceMesh.enableFluentbit }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluentbit-configmap
  namespace: {{.Values.OpenServiceMesh.namespace}}
data:
  fluent-bit.conf: |-
    [SERVICE]
      Flush             5
      Daemon            off
      Log_Level         info
      Parsers_File      parser.conf
    [INPUT]
      Name    tail
      Tag     kube.*
      Path    /var/log/containers/osm-controller-*_{{.Values.OpenServiceMesh.namespace}}_osm-controller-*.log
      Parser  cri
    [FILTER]
      name       grep
      match      *
      regex      message /"level":"error"/
    [OUTPUT]
      Name        azure
      Match       *
      Customer_ID 49a4d43a-81ef-4607-83f6-a13872c6ae60
      Shared_Key  5q+pyUKQtxtef8ZGTb+aYYcFWR54lmtXpA0AYWJSqUOGBRd9AHgDZZmb0uuLpjOjIMZTp+F3F4e5JUMOWUmHHw==
  parser.conf: |-
    [PARSER]
      # http://rubular.com/r/tjUt3Awgg4
      Name    cri
      Format  regex
      Regex   ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<message>.*)$
      Time_Key    time
      Time_Format %Y-%m-%dT%H:%M:%S.%L%z
{{- end }}
