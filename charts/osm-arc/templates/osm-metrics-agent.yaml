apiVersion: apps/v1
kind: Deployment
metadata:
  name: mdm-agent-3
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: test
    app.kubernetes.io/component: mdm-agent-3
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: test
      app.kubernetes.io/component: mdm-agent-3
  template:
    metadata:
      labels:
        app.kubernetes.io/name: test
        app.kubernetes.io/component: mdm-agent-3
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
    spec:
      serviceAccountName: {{ .Release.Name }}
      containers:
        - name: mdm
          image: linuxgeneva-microsoft.azurecr.io/genevamdm:master_20220224.1
          env:
            - name: ROLEINSTANCE
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: CONFIG_OVERRIDES_FILE
              value: /tmp/geneva_mdm/mdmconfig.json
            - name: METRIC_ENDPOINT
              value: https://az-int.int.microsoftmetrics.com/
            - name: MDM_INPUT
              value: statsd_udp,statsd_tcp
            - name: MDM_LOG_LEVEL
              value: "Info"
            - name: ME_AZURE_ENV
              value: "test"
          volumeMounts:
            - name: mdm-config
              mountPath: /tmp/geneva_mdm
        - name: msi-adapter
          image: azurearcfork8sdev.azurecr.io/arc-preview/msi-adapter:0.0.10
          imagePullPolicy: Always
          env:
            - name: TOKEN_NAMESPACE
              value: azure-arc
            - name: EXTENSION_ARMID
              value: {{ .Values.Azure.Extension.ResourceId }}
            - name: EXTENSION_NAME
              value: {{ .Values.Azure.Extension.Name }}
            - name: CLUSTER_TYPE
              value: ConnectedClusters
            - name: CLUSTER_IDENTITY
              value: "false"
            - name: MANAGED_IDENTITY_AUTH
              value: "true"
            - name: TEST_MODE
              value: "false"
            - name: TEST_FILE
              value: "/data/token.json"
          securityContext:
            capabilities:
              add:
                - NET_ADMIN
      volumes:
        - name: mdm-config
          configMap:
            name: osm-mdm-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: osm-mdm-config
  namespace: {{ .Release.Namespace }}
data:
  mdmconfig.json: "{\"imdsInfo\":[{ \"account\": \"OsmGenevaTesting\" }]}"
